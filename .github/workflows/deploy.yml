name: Production Deployment (Tag Based)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to deploy (e.g. v1.0.2)"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ inputs.tag }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Build (standalone)
        env:
          NODE_ENV: production
          PORT: 80
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          REDIS_URL: redis://127.0.0.1:6379
          QUEUE_NAME: default
          QUEUE_PREFIX: bull
          SMTP_EMAIL: tech.inrext@gmail.com
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_FROM: YourApp Support <tech.inrext@gmail.com>
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AWS_REGION: ap-south-1
          AWS_BUCKET_NAME: inrext
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: yarn build

      - name: Build worker
        run: yarn worker:build

      - name: Prepare runtime bundle (standalone)
        run: |
          set -e
          rm -rf runtime
          mkdir runtime
          cp -R .next/standalone/. runtime/
          mkdir -p runtime/.next
          cp -R .next/static runtime/.next/
          cp -R dist/worker/worker.cjs runtime/worker/worker.cjs

      - name: Upload runtime to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "runtime/**"
          target: "/home/ubuntu/crm"

      - name: Restart pm2 on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd /home/ubuntu/crm/runtime
            pm2 delete all
            pm2 start server.js --update-env
            pm2 save
            pm2 status
